version: 0.1
component: build
timeoutInSeconds: 20000
runAs: root
shell: bash
env:
  vaultVariables:
    configFile : ocid1.vaultsecret.oc1.iad.amaaaaaam4dsnniathe2aptqi45b422kpb3vhzkoqebrw3mpm3poidrcvmxq
    ociCliApiPrivateKey : ocid1.vaultsecret.oc1.iad.amaaaaaam4dsnniavcfxfwfgds2mtxfi4jxwygo4bofdz4cicb3kvgvcas2a
  exportedVariables:
   - version
steps:
  - type: Command
    name: "Install python and OCI CLI version"
    command: |
      yum groupinstall 'development tools' -y && yum install wget openssl-devel bzip2-devel libffi-devel xz-devel -y

      mkdir -p /workspace/oci-cli
      echo $ociCliApiPrivateKey | base64 --decode > /workspace/oci-cli/oci_api_key.pem
      echo $configFile | base64 --decode > /workspace/oci-cli/config
      export OCI_CLI_AUTH=api_key
      export OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING=True
      export OCI_CLI_CONFIG_FILE=/workspace/oci-cli/config
      
      yum -y install gcc wget openssl-devel bzip2-devel libffi-devel
      wget https://www.python.org/ftp/python/3.8.13/Python-3.8.13.tgz
      tar -xzf Python-3.8.13.tgz
      cd Python-3.8.13
      ./configure --enable-optimizations --with-ssl
      make altinstall
      python3.8 -m venv oracle-cli
      source oracle-cli/bin/activate
      pip install oci-cli==3.15.2
      oci --version
      oci os ns get
      oci artifacts container image-signature sign-upload --compartment-id ocid1.compartment.oc1..aaaaaaaafkqteb2m6oygf6hr4wtpkf4g3il45zj26zsnhtx7umr54t7sxlga --kms-key-id ocid1.key.oc1.iad.bfqoq3jraaeuk.abuwcljriogmsr5mwvq7nf52fhxir5mps2agbzf5wgwo7zlt3xa4rvfxkzaa --kms-key-version-id ocid1.keyversion.oc1.iad.bfqoq3jraaeuk.aum6mmu7byyaa.abuwcljrxqca4uobjt4vuerae64jquuhm2n5fdewqaeoenothr472omqk5tq --signing-algorithm SHA_512_RSA_PKCS_PSS --image-id ocid1.containerimage.oc1.iad.0.axsewmzamo2h.aaaaaaaaythautjysau5tnicifwvo2o7o7qjdew3iutnrsxtfskzvcppz3ga --output json --debug
